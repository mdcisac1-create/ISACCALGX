!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Chatbot Simples</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center h-screen">

  <!-- Botão flutuante -->
  <button id="chatToggle" class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-full shadow-lg">
    🤖 Chat
  </button>

  <!-- Painel do chat -->
  <div id="chatPanel" class="hidden fixed bottom-20 right-6 w-96 bg-gray-800 rounded-2xl shadow-xl flex flex-col overflow-hidden border border-gray-700">
    <!-- Cabeçalho -->
    <div class="flex justify-between items-center bg-blue-700 px-4 py-2">
      <span class="font-bold text-white">🤖 Robô Simpático</span>
      <button id="chatClose" class="text-white hover:text-gray-300">✖</button>
    </div>

    <!-- Área de mensagens -->
    <div id="chatMessages" class="flex-1 p-3 space-y-2 overflow-y-auto text-sm"></div>

    <!-- Formulário do chat -->
    <form id="chatForm" class="flex border-t border-gray-700">
      <input id="chatInput" type="text" placeholder="Digite sua mensagem..." class="flex-1 px-3 py-2 bg-gray-900 text-white focus:outline-none">
      <button type="submit" class="px-4 bg-blue-600 hover:bg-blue-700">➤</button>
    </form>
  </div>

  <!-- Base de conhecimento -->
  <div class="absolute top-6 left-6 bg-gray-800 border border-gray-700 rounded-xl p-4 w-96">
    <h2 class="font-bold mb-2">📚 Base de Conhecimento</h2>
    <form id="kbForm" class="flex flex-col gap-2 mb-3">
      <input id="kbQ" type="text" placeholder="Pergunta" class="px-2 py-1 bg-gray-900 text-white rounded-md">
      <input id="kbA" type="text" placeholder="Resposta" class="px-2 py-1 bg-gray-900 text-white rounded-md">
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded-md">Salvar</button>
    </form>
    <ul id="kbList" class="space-y-2 text-sm"></ul>
    <button id="kbClear" class="mt-3 bg-red-600 hover:bg-red-700 px-3 py-1 rounded-md">Limpar tudo</button>
  </div>

  <script>
    const chatToggle = document.getElementById('chatToggle');
    const chatPanel = document.getElementById('chatPanel');
    const chatClose = document.getElementById('chatClose');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const chatMessages = document.getElementById('chatMessages');
    const kbForm = document.getElementById('kbForm');
    const kbQ = document.getElementById('kbQ');
    const kbA = document.getElementById('kbA');
    const kbList = document.getElementById('kbList');
    const kbClear = document.getElementById('kbClear');

    function loadKB(){
      try{ return JSON.parse(localStorage.getItem('kbPairs')||'[]'); }catch{ return []; }
    }
    function saveKB(pairs){ localStorage.setItem('kbPairs', JSON.stringify(pairs)); }

    if(loadKB().length === 0){
      saveKB([
        { q:"oi", a:"Olá! Tudo bem? 😊", t:Date.now() },
        { q:"qual seu nome", a:"Eu sou o Robô Simpático! 🤖", t:Date.now() },
        { q:"que horas são", a:"Agora é " + new Date().toLocaleTimeString(), t:Date.now() }
      ]);
    }

    function renderKB(){
      const pairs = loadKB();
      kbList.innerHTML = '';
      pairs.forEach((p, i)=>{
        const li = document.createElement('li');
        li.className = 'flex items-start justify-between gap-2';
        li.innerHTML = `<span class="block"><b>Q:</b> ${p.q}<br/><b>A:</b> ${p.a}</span>`;
        const del = document.createElement('button');
        del.className = 'shrink-0 rounded-md bg-white/10 hover:bg-white/15 px-2 py-1';
        del.textContent = 'remover';
        del.addEventListener('click', ()=>{
          const all = loadKB(); all.splice(i,1); saveKB(all); renderKB();
        });
        li.appendChild(del);
        kbList.appendChild(li);
      });
    }

    chatToggle.addEventListener('click', ()=>{
      chatPanel.classList.toggle('hidden');
      if(!chatPanel.classList.contains('hidden')) setTimeout(()=>chatInput.focus(), 50);
    });
    chatClose.addEventListener('click', ()=> chatPanel.classList.add('hidden'));

    function addMsg(text, from='bot'){
      const wrap = document.createElement('div');
      wrap.className = from==='user' ? 'text-right' : 'text-left';
      const bubble = document.createElement('div');
      bubble.className = `inline-block max-w-[85%] px-3 py-2 rounded-xl ${from==='user' ? 'bg-blue-600 text-white' : 'bg-white/10 text-white/90'}`;
      bubble.textContent = text;
      wrap.appendChild(bubble);
      chatMessages.appendChild(wrap);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function findAnswer(q){
      const pairs = loadKB();
      const query = q.toLowerCase().trim();
      let best = null; let bestScore = 0;
      pairs.forEach(p=>{
        const target = (p.q||'').toLowerCase();
        let score = 0;
        if(target.includes(query) || query.includes(target)) score += 2;
        const words = query.split(/\s+/);
        score += words.filter(w=> target.includes(w)).length * 0.3;
        if(score>bestScore){ bestScore = score; best = p; }
      });
      return best && bestScore>0 ? best.a : null;
    }

    chatForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const q = chatInput.value.trim(); if(!q) return;
      addMsg(q, 'user');
      chatInput.value = '';
      const found = findAnswer(q);
      if(found){
        setTimeout(()=> addMsg(found, 'bot'), 300);
      } else {
        setTimeout(()=> addMsg('Não sei isso ainda 🤔. Adicione uma resposta na "Base de conhecimento".', 'bot'), 300);
      }
    });

    kbForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const q = kbQ.value.trim();
      const a = kbA.value.trim();
      if(!q || !a) return;
      const pairs = loadKB();
      pairs.unshift({ q, a, t: Date.now() });
      saveKB(pairs);
      kbQ.value=''; kbA.value='';
      renderKB();
      addMsg('Novo conhecimento salvo! Agora já sei responder isso. 😎', 'bot');
    });

    kbClear.addEventListener('click', ()=>{
      localStorage.removeItem('kbPairs');
      renderKB();
      addMsg('Base de conhecimento apagada 🚮', 'bot');
    });

    renderKB();
  </script>
</body>
</html>
